<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–∞—à –ò–≥—Ä–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #1a1a2e; color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .balance-info { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-bottom: 20px; text-align: center; font-size: 18px; }
        .game-area { background: rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
        .bet-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .bet-input { flex: 2; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: white; font-size: 16px; text-align: center; }
        .bet-buttons { display: flex; gap: 5px; flex: 1; }
        .bet-btn { padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: white; cursor: pointer; flex: 1; font-size: 12px; }
        .rocket-container { position: relative; height: 200px; margin: 20px 0; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; }
        .rocket { width: 50px; height: 80px; background: linear-gradient(45deg, #ff6b6b, #ffa726); border-radius: 10px 10px 5px 5px; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); transition: bottom 0.1s linear; }
        .rocket::after { content: ''; position: absolute; bottom: -15px; left: 10px; width: 30px; height: 15px; background: #ffa726; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .rocket::before { content: ''; position: absolute; bottom: -25px; left: 5px; width: 40px; height: 20px; background: linear-gradient(to top, #ff9500, #ff0000, transparent); border-radius: 50%; animation: flame 0.3s infinite alternate; }
        @keyframes flame { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(1.2); opacity: 1; } }
        .multiplier { font-size: 32px; font-weight: bold; text-align: center; margin: 20px 0; color: #4ecdc4; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        button { padding: 15px; border: none; border-radius: 10px; font-size: 16px; flex: 1; cursor: pointer; font-weight: bold; }
        .start-btn { background: linear-gradient(45deg, #4ecdc4, #44a08d); color: white; }
        .stop-btn { background: linear-gradient(45deg, #ff6b6b, #ffa726); color: white; }
        .withdraw-btn { background: linear-gradient(45deg, #ffd700, #ff6b00); color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .history { margin-top: 20px; }
        .history-title { text-align: center; margin-bottom: 10px; color: #ccc; }
        .history-item { background: rgba(255,255,255,0.05); padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; }
        .win { color: #4ecdc4; } .lose { color: #ff6b6b; }
        .status { text-align: center; margin: 10px 0; font-size: 14px; color: #ccc; }
        .profit { text-align: center; margin: 10px 0; font-size: 16px; font-weight: bold; }
        .error { background: #ff4444; color: white; padding: 10px; border-radius: 10px; text-align: center; margin: 10px 0; }
        .success { background: #4ecdc4; color: white; padding: 10px; border-radius: 10px; text-align: center; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>üöÄ –ö–†–ê–® –ò–ì–†–ê</h1></div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="successMessage" class="success" style="display: none;"></div>
        <div class="balance-info" id="balanceInfo">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞...</div>
        <div class="game-area">
            <div class="bet-controls">
                <input type="number" class="bet-input" id="betAmount" value="1000" min="1">
                <div class="bet-buttons">
                    <button class="bet-btn" onclick="setBetPercent(0.25)">25%</button>
                    <button class="bet-btn" onclick="setBetPercent(0.5)">50%</button>
                    <button class="bet-btn" onclick="setBetPercent(1)">MAX</button>
                </div>
            </div>
            <div class="rocket-container"><div class="rocket" id="rocket"></div></div>
            <div class="multiplier" id="multiplier">1.00x</div>
            <div class="profit" id="profitDisplay">–ü—Ä–∏–±—ã–ª—å: +0‚ÇΩ</div>
            <div class="status" id="status">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏—Ç–µ –°–¢–ê–†–¢</div>
            <div class="controls">
                <button class="start-btn" onclick="startGame()" id="startBtn">–°–¢–ê–†–¢</button>
                <button class="stop-btn" onclick="stopGame()" id="stopBtn" disabled>–°–¢–û–ü</button>
                <button class="withdraw-btn" onclick="withdrawAll()" id="withdrawBtn">–í–´–í–û–î</button>
            </div>
        </div>
        <div class="history">
            <div class="history-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã:</div>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        let gameActive = false;
        let currentMultiplier = 1.00;
        let gameInterval;
        let currentBet = 1000;
        let gameBalance = 0;
        let sessionId = null;
        let gameHistory = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionId = urlParams.get('session_id');
            
            if (!sessionId) {
                showError('‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å–µ—Å—Å–∏—è! –ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞.');
                return;
            }
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –±–∞–ª–∞–Ω—Å —É –±–æ—Ç–∞
            requestBalance();
            
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
                setupBotMessageListener();
            }
        });
        
        function setupBotMessageListener() {
            // –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
            const originalSendData = Telegram.WebApp.sendData;
            
            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ–±–∞–≥–∞
            Telegram.WebApp.sendData = function(data) {
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É:', data);
                return originalSendData.call(this, data);
            };
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }
        
        function requestBalance() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'get_balance',
                    session_id: sessionId
                }));
                console.log('üì® –ó–∞–ø—Ä–æ—à–µ–Ω –±–∞–ª–∞–Ω—Å –¥–ª—è —Å–µ—Å—Å–∏–∏:', sessionId);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                if (gameBalance === 0) {
                    showError('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å. –ü–µ—Ä–µ–∑–∞–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.');
                }
            }, 3000);
        }
        
        function updateBalanceInfo() {
            document.getElementById('balanceInfo').textContent = `üí∞ –ò–≥—Ä–æ–≤–æ–π –±–∞–ª–∞–Ω—Å: ${formatBalance(gameBalance)}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫
            document.getElementById('startBtn').disabled = gameBalance <= 0 || gameActive;
            document.getElementById('withdrawBtn').disabled = gameBalance <= 0 || gameActive;
        }
        
        function formatBalance(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.floor(amount)) + '‚ÇΩ';
        }
        
        function updateProfitDisplay() {
            const potentialProfit = Math.floor(currentBet * currentMultiplier) - currentBet;
            const profitText = potentialProfit >= 0 ? `+${formatBalance(potentialProfit)}` : formatBalance(potentialProfit);
            document.getElementById('profitDisplay').textContent = `–ü—Ä–∏–±—ã–ª—å: ${profitText}`;
            document.getElementById('profitDisplay').style.color = potentialProfit >= 0 ? '#4ecdc4' : '#ff6b6b';
        }
        
        function setBetPercent(percent) {
            if (gameActive) return;
            currentBet = Math.floor(gameBalance * percent);
            currentBet = Math.max(1, Math.min(gameBalance, currentBet));
            document.getElementById('betAmount').value = currentBet;
            updateProfitDisplay();
        }
        
        function startGame() {
            if (gameActive) return;
            
            currentBet = parseInt(document.getElementById('betAmount').value);
            if (!currentBet || currentBet <= 0 || currentBet > gameBalance) {
                showError('‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É–º–º—É.');
                return;
            }
            
            // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
            gameBalance -= currentBet;
            updateGameBalance();
            updateBalanceInfo();
            
            gameActive = true;
            currentMultiplier = 1.00;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('withdrawBtn').disabled = true;
            document.getElementById('status').textContent = "üöÄ –†–∞–∫–µ—Ç–∞ –≤–∑–ª–µ—Ç–∞–µ—Ç...";
            document.getElementById('status').style.color = '#4ecdc4';
            
            hideMessages();
            
            const rocket = document.getElementById('rocket');
            let position = 0;
            
            gameInterval = setInterval(() => {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º —É—Å–∫–æ—Ä–µ–Ω–∏–µ–º
                currentMultiplier += 0.01 + (Math.random() * 0.03);
                document.getElementById('multiplier').textContent = currentMultiplier.toFixed(2) + 'x';
                updateProfitDisplay();
                
                // –î–≤–∏–≥–∞–µ–º —Ä–∞–∫–µ—Ç—É
                position = Math.min(150, (currentMultiplier - 1) * 30);
                rocket.style.bottom = position + 'px';
                
                // –®–∞–Ω—Å –∫—Ä–∞—à–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º
                const crashChance = Math.min(0.5, (currentMultiplier - 1) * 0.08);
                if (Math.random() < crashChance) {
                    endGame(false);
                }
            }, 100);
        }
        
        function stopGame() {
            if (!gameActive) return;
            endGame(true);
        }
        
        function endGame(isStop) {
            clearInterval(gameInterval);
            gameActive = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('withdrawBtn').disabled = gameBalance <= 0;
            
            const winAmount = isStop ? Math.floor(currentBet * currentMultiplier) : 0;
            const profit = winAmount - currentBet;
            
            if (isStop) {
                // –í—ã–∏–≥—Ä—ã—à
                gameBalance += winAmount;
                addToHistory(true, currentMultiplier, profit);
                document.getElementById('status').textContent = `‚úÖ –í—ã —É—Å–ø–µ–ª–∏! –í—ã–≤–µ–ª–∏ –Ω–∞ x${currentMultiplier.toFixed(2)}!`;
                document.getElementById('status').style.color = '#4ecdc4';
                showSuccess(`üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${formatBalance(profit)}!`);
            } else {
                // –ü—Ä–æ–∏–≥—Ä—ã—à
                addToHistory(false, currentMultiplier, -currentBet);
                document.getElementById('status').textContent = `üí• –†–∞–∫–µ—Ç–∞ —É–ø–∞–ª–∞ –Ω–∞ x${currentMultiplier.toFixed(2)}`;
                document.getElementById('status').style.color = '#ff6b6b';
                showError(`üòû –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ ${formatBalance(currentBet)}`);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            updateGameBalance();
            updateBalanceInfo();
            updateProfitDisplay();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                document.getElementById('rocket').style.bottom = '0px';
                document.getElementById('multiplier').textContent = '1.00x';
                document.getElementById('status').textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏—Ç–µ –°–¢–ê–†–¢';
                document.getElementById('status').style.color = '#ccc';
                currentMultiplier = 1.00;
                updateProfitDisplay();
                hideMessages();
            }, 3000);
        }
        
        function updateGameBalance() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'update_balance',
                    session_id: sessionId,
                    new_balance: gameBalance
                }));
                console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω –±–∞–ª–∞–Ω—Å:', gameBalance);
            }
        }
        
        function withdrawAll() {
            if (gameActive) { 
                showError('‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É –ø–µ—Ä–µ–¥ –≤—ã–≤–æ–¥–æ–º!'); 
                return; 
            }
            
            if (gameBalance <= 0) { 
                showError('‚ùå –ù–µ—Ç —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞!'); 
                return; 
            }
            
            if (confirm(`–í—ã–≤–µ—Å—Ç–∏ ${formatBalance(gameBalance)} –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∞–ª–∞–Ω—Å?`)) {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.sendData(JSON.stringify({
                        action: 'crash_withdraw',
                        session_id: sessionId,
                        amount: gameBalance
                    }));
                    
                    showSuccess(`‚úÖ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ ${formatBalance(gameBalance)} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`);
                    console.log('üì§ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥:', gameBalance);
                    
                    // –û–±–Ω—É–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
                    gameBalance = 0;
                    updateBalanceInfo();
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        if (window.Telegram && Telegram.WebApp) {
                            Telegram.WebApp.close();
                        }
                    }, 2000);
                } else {
                    showError('‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–æ—Ç–æ–º!');
                }
            }
        }
        
        function addToHistory(isWin, multiplier, profit) {
            const historyItem = { 
                isWin, 
                multiplier, 
                profit, 
                time: new Date().toLocaleTimeString('ru-RU') 
            };
            gameHistory.unshift(historyItem);
            if (gameHistory.length > 5) gameHistory.pop();
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            gameHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = `history-item ${item.isWin ? 'win' : 'lose'}`;
                const profitText = item.profit >= 0 ? `+${formatBalance(item.profit)}` : formatBalance(item.profit);
                div.innerHTML = `
                    <span>${item.multiplier.toFixed(2)}x</span>
                    <span>${profitText}</span>
                    <span>${item.time}</span>
                `;
                historyList.appendChild(div);
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('betAmount').addEventListener('input', function() {
            if (!gameActive) {
                currentBet = parseInt(this.value) || 0;
                currentBet = Math.max(1, Math.min(gameBalance, currentBet));
                this.value = currentBet;
                updateProfitDisplay();
            }
        });
        
        document.getElementById('betAmount').addEventListener('blur', function() {
            if (!gameActive) {
                currentBet = parseInt(this.value) || 0;
                currentBet = Math.max(1, Math.min(gameBalance, currentBet));
                this.value = currentBet;
                updateProfitDisplay();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
        if (window.Telegram && Telegram.WebApp) {
            // –°–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
            setInterval(() => {
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Bot API
                // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            }, 1000);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞ (–µ—Å–ª–∏ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ sendMessage)
            Telegram.WebApp.onEvent('webAppDataReceived', function(data) {
                try {
                    console.log('üì® –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞:', data);
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑–≤–Ω–µ)
        window.handleBotMessage = function(messageText) {
            try {
                if (messageText && messageText.startsWith('BALANCE:')) {
                    const data = JSON.parse(messageText.substring(8));
                    if (data.action === 'balance_update') {
                        gameBalance = data.balance;
                        updateBalanceInfo();
                        hideMessages();
                        console.log('‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—É—á–µ–Ω:', gameBalance);
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞:', e);
            }
        };
        
        // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        setTimeout(() => {
            if (gameBalance === 0) {
                // –¢–µ—Å—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
                gameBalance = 10000;
                updateBalanceInfo();
                hideMessages();
            }
        }, 1000);
        
    </script>
</body>
</html>
